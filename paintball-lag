--// HUB: Spam Tools v2 + Auto Laser + Spam Laser + Tool Toggles + Spin (fixed)
local player = game.Players.LocalPlayer
local players = game.Players
local rs = game:GetService("RunService")
local replicated = game:GetService("ReplicatedStorage")

local remote = replicated:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/UseItem")

-- GUI
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.ResetOnSpawn = false

-- Hub Frame
local hub = Instance.new("Frame", gui)
hub.Size = UDim2.new(0, 220, 0, 260)
hub.Position = UDim2.new(0.7, 0, 0.25, 0)
hub.BackgroundColor3 = Color3.fromRGB(0,0,0)
hub.Active = true
hub.Draggable = true
hub.BorderSizePixel = 0
Instance.new("UICorner", hub).CornerRadius = UDim.new(0,15)

-- Ordered tool list (keys must match actual tool names used in equipAndSpam)
local toolNamesOrdered = {"Megaphone", "Rage Table", "Bee Launcher"}
local toolToggles = {["Megaphone"]=false, ["Rage Table"]=false, ["Bee Launcher"]=false}

local yPos = 10
for _, tool in ipairs(toolNamesOrdered) do
    local btnToggle = Instance.new("TextButton", hub)
    btnToggle.Size = UDim2.new(1, -20, 0, 30)
    btnToggle.Position = UDim2.new(0, 10, 0, yPos)
    btnToggle.BackgroundColor3 = Color3.fromRGB(30,30,30)
    btnToggle.Text = tool..": OFF"
    btnToggle.TextColor3 = Color3.new(1,1,1)
    btnToggle.Font = Enum.Font.GothamBold
    btnToggle.TextScaled = true
    Instance.new("UICorner", btnToggle).CornerRadius = UDim.new(0,8)
    btnToggle.MouseButton1Click:Connect(function()
        toolToggles[tool] = not toolToggles[tool]
        btnToggle.Text = tool..": "..(toolToggles[tool] and "ON" or "OFF")
    end)
    yPos = yPos + 35
end

-- Spam Tools Button
local btn = Instance.new("TextButton", hub)
btn.Size = UDim2.new(1, -20, 0, 50)
btn.Position = UDim2.new(0, 10, 0, yPos)
btn.BackgroundColor3 = Color3.fromRGB(0,0,0)
btn.Text = "Spam Tools v2 [OFF]"
btn.TextColor3 = Color3.new(1,1,1)
btn.Font = Enum.Font.GothamBold
btn.TextScaled = true
Instance.new("UICorner", btn).CornerRadius = UDim.new(0,12)
yPos += 60

local enabled = false
local loopConn

-- Auto Laser Button
local laserBtn = Instance.new("TextButton", hub)
laserBtn.Size = UDim2.new(1, -20, 0, 40)
laserBtn.Position = UDim2.new(0, 10, 0, yPos)
laserBtn.BackgroundColor3 = Color3.fromRGB(0,0,0)
laserBtn.Text = "Auto Laser [OFF]"
laserBtn.TextColor3 = Color3.new(1,1,1)
laserBtn.Font = Enum.Font.GothamBold
laserBtn.TextScaled = true
Instance.new("UICorner", laserBtn).CornerRadius = UDim.new(0,12)
yPos += 50

local laserEnabled = false

-- Spam Laser Button
local spamLaserBtn = Instance.new("TextButton", hub)
spamLaserBtn.Size = UDim2.new(1, -20, 0, 40)
spamLaserBtn.Position = UDim2.new(0, 10, 0, yPos)
spamLaserBtn.BackgroundColor3 = Color3.fromRGB(0,0,0)
spamLaserBtn.Text = "Spam Laser [OFF]"
spamLaserBtn.TextColor3 = Color3.new(1,1,1)
spamLaserBtn.Font = Enum.Font.GothamBold
spamLaserBtn.TextScaled = true
Instance.new("UICorner", spamLaserBtn).CornerRadius = UDim.new(0,12)

local spamLaser = false
local spamLaserConn

-- RGB Fade
local t = 0
rs.RenderStepped:Connect(function(dt)
    t = t + dt*2
    local alpha = (math.sin(t)+1)/2
    btn.BackgroundColor3 = Color3.fromRGB(math.floor(0 + 155*alpha),0,math.floor(0 + 255*alpha))

    if laserEnabled then
        laserBtn.BackgroundColor3 = Color3.fromRGB(math.floor(0 + 155*alpha),0,math.floor(0 + 255*alpha))
    else
        laserBtn.BackgroundColor3 = Color3.fromRGB(0,0,0)
    end

    if spamLaser then
        spamLaserBtn.BackgroundColor3 = Color3.fromRGB(math.floor(0 + 155*alpha),0,math.floor(0 + 255*alpha))
    else
        spamLaserBtn.BackgroundColor3 = Color3.fromRGB(0,0,0)
    end
end)

-- RETURNS nearest player's __HITBOX
local function getNearestHitbox()
    local char = player.Character
    if not char then return nil end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return nil end

    local nearestDist = math.huge
    local target = nil

    for _, plr in ipairs(players:GetPlayers()) do
        if plr ~= player and plr.Character then
            local hb = plr.Character:FindFirstChild("__HITBOX")
            if hb and hb:IsA("BasePart") then
                local dist = (hb.Position - root.Position).Magnitude
                if dist < nearestDist then
                    nearestDist = dist
                    target = hb
                end
            end
        end
    end

    return target
end

-- Equip + spam helper (keeps behavior, used for the intro sequence)
local function equipAndSpam(toolName,duration)
    local char = player.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return end
    local backpack = player:FindFirstChildOfClass("Backpack")
    local tool = char:FindFirstChild(toolName) or (backpack and backpack:FindFirstChild(toolName))
    if not tool then return end
    if tool.Parent ~= char then
        pcall(function() hum:EquipTool(tool) end)
    end

    local start = tick()
    while tick() - start < duration do
        if tool.Parent ~= char then
            pcall(function() hum:EquipTool(tool) end)
        end
        pcall(function() tool:Activate() end)
        task.wait(0.01)
    end
end


-- ================================================================
-- === PAINTBALL GUN ALWAYS-EQUIPPED SYSTEM (ON ONLY) ============
-- ================================================================

local function stopPaintballEquip()
    for _, v in pairs({"Conn","CharConn","BpAdd","BpRem"}) do
        local key = "_pg"..v
        if _G[key] then
            pcall(function() _G[key]:Disconnect() end)
            _G[key] = nil
        end
    end
    _G._pgLast = nil
end

local function startPaintballEquip()
    stopPaintballEquip()

    local function pgEquip()
        local char = player.Character
        local bp = player:FindFirstChild("Backpack")
        if not char or not bp then return end

        local hum = char:FindFirstChildOfClass("Humanoid")
        if not hum then return end

        local tool = bp:FindFirstChild("Paintball Gun") or char:FindFirstChild("Paintball Gun")
        if tool and tool.Parent ~= char then
            pcall(function() hum:EquipTool(tool) end)
        end
    end

    -- Heartbeat re-equip (shorter interval so equip delay is minimized)
    _G._pgConn = rs.Heartbeat:Connect(function()
        if tick() - (_G._pgLast or 0) >= 0.15 then
            _G._pgLast = tick()
            pgEquip()
        end
    end)

    -- Re-equip after respawn
    _G._pgCharConn = player.CharacterAdded:Connect(function()
        task.wait(0.35)
        pgEquip()
    end)

    -- Monitor backpack changes
    local bp = player:FindFirstChild("Backpack")
    if bp then
        _G._pgBpAdd = bp.ChildAdded:Connect(pgEquip)
        _G._pgBpRem = bp.ChildRemoved:Connect(pgEquip)
    end

    -- First equip immediately
    pgEquip()
end


-- Paintball spam loop
local function startLoop()
    if loopConn then loopConn:Disconnect() end

    -- Activate always-equip system while loop active
    startPaintballEquip()

    loopConn = rs.Heartbeat:Connect(function()
        if not enabled then return end

        local char = player.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if not hum then return end

        local bp = player:FindFirstChild("Backpack")
        local paint = char:FindFirstChild("Paintball Gun") or (bp and bp:FindFirstChild("Paintball Gun"))
        if not paint then return end

        -- paint is already being kept equipped by startPaintballEquip
        pcall(function() paint:Activate() end)

        local hb = getNearestHitbox()
        if hb then
            pcall(function() remote:FireServer(hb.Position, hb) end)
        end
    end)
end

-- Spin logic
local function applySpin(state)
    local function stop()
        local char = player.Character
        if not char then return end
        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then return end
        local s = root:FindFirstChild("Spinning")
        if s then s:Destroy() end
    end

    if not state then stop(); return end

    local SPEED = 20
    local function apply()
        local char = player.Character
        if not char then return end
        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then return end
        local old = root:FindFirstChild("Spinning")
        if old then old:Destroy() end

        local spin = Instance.new("BodyAngularVelocity")
        spin.Name = "Spinning"
        spin.Parent = root
        spin.MaxTorque = Vector3.new(0, math.huge, 0)
        spin.AngularVelocity = Vector3.new(0, SPEED, 0)
    end

    apply()
    player.CharacterAdded:Connect(function()
        task.wait(0.1)
        apply()
    end)
end

-- Spam Tools toggle
btn.MouseButton1Click:Connect(function()
    enabled = not enabled
    applySpin(enabled)
    if enabled then
        btn.Text = "Spam Tools v2 [ON]"
        local anyTools =
            toolToggles["Megaphone"] or
            toolToggles["Rage Table"] or
            toolToggles["Bee Launcher"]

        if anyTools then
            task.spawn(function()
                if toolToggles["Megaphone"] then equipAndSpam("Megaphone",0.2) end
                if toolToggles["Rage Table"] then equipAndSpam("Rage Table",0.5) end
                if toolToggles["Bee Launcher"] then equipAndSpam("Bee Launcher",0.5) end
            end)
            -- start paintball loop immediately (no artificial extra delay)
            startLoop()
        else
            -- No tools selected, start Paintball spam immediately
            startLoop()
        end
    else
        btn.Text = "Spam Tools v2 [OFF]"
        if loopConn then loopConn:Disconnect() end

        -- Turn off always-equip system
        stopPaintballEquip()

        -- Unequip everything (prevent forced equip when off)
        local char = player.Character
        if char then
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then pcall(function() hum:UnequipTools() end) end
        end
    end
end)

-- Auto Laser toggle
laserBtn.MouseButton1Click:Connect(function()
    laserEnabled = not laserEnabled
    laserBtn.Text = "Auto Laser [" .. (laserEnabled and "ON" or "OFF") .. "]"
end)

-- Auto Laser logic
local notifFolder = player:WaitForChild("PlayerGui"):WaitForChild("Notification"):WaitForChild("Notification")
notifFolder.ChildAdded:Connect(function(child)
    if not laserEnabled then return end

    task.wait(0.05)
    local textLabel = child:FindFirstChildWhichIsA("TextLabel")
    if textLabel and textLabel.Text:match("Someone is stealing your") then

        -- Equip laser
        local char = player.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if hum then
            local cape = char:FindFirstChild("Laser Cape") or player.Backpack:FindFirstChild("Laser Cape")
            if cape then pcall(function() hum:EquipTool(cape) end) end
        end

        local hb = getNearestHitbox()
        if hb then
            pcall(function() remote:FireServer(hb.Position, hb) end)
        end

        -- Auto Laser unequips
        task.wait(0.1)
        if hum then pcall(function() hum:UnequipTools() end) end
    end
end)

-- Spam Laser toggle
spamLaserBtn.MouseButton1Click:Connect(function()
    spamLaser = not spamLaser
    spamLaserBtn.Text = "Spam Laser [" .. (spamLaser and "ON" or "OFF") .. "]"

    if spamLaser then
        -- Equip cape immediately
        local char = player.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if hum then
            local cape = char:FindFirstChild("Laser Cape") or player.Backpack:FindFirstChild("Laser Cape")
            if cape then pcall(function() hum:EquipTool(cape) end) end
        end

        -- Start spamming
        spamLaserConn = rs.Heartbeat:Connect(function()
            if not spamLaser then return end
            local hb = getNearestHitbox()
            if hb then
                pcall(function() remote:FireServer(hb.Position, hb) end)
            end
        end)
    else
        if spamLaserConn then spamLaserConn:Disconnect() end
    end
end)
